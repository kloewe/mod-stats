#-----------------------------------------------------------------------------
# File    : makefile-oct
# Contents: build objects
# Author  : Kristian Loewe
#           (with modifications for octave by Christina Rossmanith)
#-----------------------------------------------------------------------------
.SUFFIXES:                                   # remove built-in rules
MAKEFLAGS   += -r

CPUINFODIR  = ../../cpuinfo
DOTDIR      = ../../dot

CFLAGS      = -std=c99 \
              -Wall -Wextra -Wno-unused-parameter -Wconversion -Wshadow \
              -pedantic -fPIC
COPTIMFLAGS = -O2
DEFS        = -DNDEBUG

MEXCC       = mkoctfile --mex

OBJDIR      = ../obj/$(shell uname -m)/octave
_DUMMY      := $(shell mkdir -p $(OBJDIR))

OBJS = stats.o stats_naive.o stats_sse2.o

#-----------------------------------------------------------------------------
# Build Objects
#-----------------------------------------------------------------------------
all: $(OBJS) stats_all.o

stats_naive.o:           $(OBJDIR)/stats_naive.o
$(OBJDIR)/stats_naive.o: $(DOTDIR)/src/dot_naive.h
$(OBJDIR)/stats_naive.o: stats_naive.h stats_naive_real.h
$(OBJDIR)/stats_naive.o: stats_naive.c makefile-oct
	CFLAGS='$(CFLAGS) $(COPTIMFLAGS)' $(MEXCC) \
    $(DEFS) -I$(DOTDIR)/src -c $< -o $@

stats_sse2.o:            $(OBJDIR)/stats_sse2.o
$(OBJDIR)/stats_sse2.o:  stats_sse2.h
$(OBJDIR)/stats_sse2.o:  stats_sse2.c makefile-oct
	CFLAGS='$(CFLAGS) $(COPTIMFLAGS) -msse2' $(MEXCC) \
    $(DEFS) -I$(DOTDIR)/src -c $< -o $@

stats.o:                 $(OBJDIR)/stats.o
$(OBJDIR)/stats.o:       stats.h $(CPUINFODIR)/src/cpuinfo.h
$(OBJDIR)/stats.o:       stats.c makefile-oct
	CFLAGS='$(CFLAGS) $(COPTIMFLAGS)' $(MEXCC) \
    $(DEFS) -I$(CPUINFODIR)/src -c $< -o $@

stats_all.o:             $(OBJDIR)/stats_all.o
stats_all.o:             makefile-oct
$(OBJDIR)/stats_all.o:   $(addprefix $(OBJDIR)/, $(OBJS))
	$(LD) -r -o $(OBJDIR)/stats_all.o $(addprefix $(OBJDIR)/, $(OBJS))
