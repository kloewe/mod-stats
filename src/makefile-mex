#-----------------------------------------------------------------------------
# File    : makefile-mex
# Contents: build objects for use with matlab/mex
# Author  : Kristian Loewe
#
# Examples: make -f makefile-mex
#           make -f makefile-mex MEX_FLAGS='-v'
#           make -f makefile-mex | grep -v 'Warning.*gcc version'
#-----------------------------------------------------------------------------
.SUFFIXES:                                   # remove built-in rules
MAKEFLAGS += -r

CPUINFODIR = ../../cpuinfo
DOTDIR     = ../../dot

CC        ?= gcc -std=c99
CFBASE     = -Wall -Wextra -Wno-unused-parameter -Wconversion -Wshadow \
             -pedantic
CFOPT     ?= -O2 -funroll-loops
DEFS      ?= -DNDEBUG
CFLAGS     = $(CFBASE) -fPIC $(DEFS)

MATLABROOT = $(dir $(realpath $(shell which matlab)))
MEX_FLAGS ?=
MEXCC      = $(realpath $(MATLABROOT))/mex -largeArrayDims $(MEX_FLAGS)

OBJDIR     = ../obj/$(shell uname -m)/matlab
_DUMMY    := $(shell mkdir -p $(OBJDIR))

OBJS = stats.o stats_naive.o stats_sse2.o

#-----------------------------------------------------------------------------
# Build Objects
#-----------------------------------------------------------------------------
all: $(OBJS) stats_all.o

stats_naive.o:           $(OBJDIR)/stats_naive.o
$(OBJDIR)/stats_naive.o: $(DOTDIR)/src/dot_naive.h
$(OBJDIR)/stats_naive.o: stats_naive.h stats_naive_real.h
$(OBJDIR)/stats_naive.o: stats_naive.c makefile-mex
	$(MEXCC) CFLAGS='$(CFLAGS)'        COPTIMFLAGS='$(CFOPT)' \
    -I$(DOTDIR)/src -c stats_naive.c -outdir $(OBJDIR)

stats_sse2.o:            $(OBJDIR)/stats_sse2.o
$(OBJDIR)/stats_sse2.o:  stats_sse2.h
$(OBJDIR)/stats_sse2.o:  stats_sse2.c makefile-mex
	$(MEXCC) CFLAGS='$(CFLAGS) -msse2' COPTIMFLAGS='$(CFOPT)' \
    -I$(DOTDIR)/src -c stats_sse2.c -outdir $(OBJDIR)

stats.o:                 $(OBJDIR)/stats.o
$(OBJDIR)/stats.o:       stats.h $(CPUINFODIR)/src/cpuinfo.h
$(OBJDIR)/stats.o:       stats.c makefile-mex
	$(MEXCC) CFLAGS='$(CFLAGS)'        COPTIMFLAGS='$(CFOPT)' \
    -I$(CPUINFODIR)/src -c stats.c -outdir $(OBJDIR)

stats_all.o:             $(OBJDIR)/stats_all.o
stats_all.o:             makefile-mex
$(OBJDIR)/stats_all.o:   $(addprefix $(OBJDIR)/, $(OBJS))
	$(LD) -r -o $(OBJDIR)/stats_all.o $(addprefix $(OBJDIR)/, $(OBJS))
